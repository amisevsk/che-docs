

[id="storage-types-for-workspaces_{context}"]
= Storage types for workspaces

Since 7.17.0 Eclipse Che supports three types of storage with different capabilities: persistent storage, ephemeral and asynchronous.

.Persistent storage

Persistent storage saves your changes directly in a mounted Persistent Volume. This option has the benefit of saving directly to a persistent store, but may encounter issues related to the storage plugin used for the Persistent Volume such as slow I/O or synchronization conflicts when modifying a large number of files. An example of when such an error can occur is when downloading dependencies for a NodeJS project, as the `node_modules` folder can contain thousands of small files.

NOTE: Speed of I/O varies depending on the link:https://kubernetes.io/docs/concepts/storage/storage-classes/[Storage Classes] configured in the environment.

This is the default mode for new workspace, and thus applies when the workspace configuration does not specify otherwise. If you want to explicitly make this setting visible in your workspace configuration you can add:
[source,yaml]
----
attributes:
 persistVolumes: ‘true’
----

.Ephemeral Storage

Ephemeral storage uses an link:https://kubernetes.io/docs/concepts/storage/volumes/#emptydir[`emptyDir`] volume to store workspace files. Such volumes exist only while the Kubernetes Pod they are attached to is running; if the pod is removed for any reason, all files stored in the volume are lost. While ephemeral storage provides fast I/O, it is necessary to ensure all changes are pushed to a remote repository, such as GitHub.

WARNING: To save the changes, commit and push any changes to a remote repository before stopping an ephemeral workspace. Otherwise, all the changes will be lost.

[source,yaml]
----
attributes:
 persistVolumes: ‘false’
----

=== Comparison table between I/O of Ephemeral (`emptyDir`) vs Persitent (link:https://kubernetes.io/docs/concepts/storage/storage-classes/#aws-ebs[AWS EBS])

[cols="3", options="header"]
|===
|Command
|Ephemeral
|Persitent

|Clone  Eclipse Che
|0m 19s
|1m 26s

|Generate 1000 random files
|1m 12s
|44m 53s
|===

.Asynchronous storage (experimental)

This is a combination of persistent and ephemeral storage. The workspace container will mount an emptyDir volume that is synchronized asynchronously with a persistent volume that stores workspace files. It has the benefits of fast I/O while allowing for persistence between workspace runs.

Synchronization is powered by link:https://rsync.samba.org/[`rsync`] via the link:https://www.openssh.com/[SSH] protocol. When a workspace is configured with an asynchronous storage type, the link:https://github.com/che-incubator/workspace-data-sync/[workspace-data-sync] plugin is automatically added to the workspace configuration. This plugin will run `rsync` on workspace start to restore changes if they exist. When a workspace is stopped, it will synchronize changes with the backing permanent storage. The rsync process can take some time, so a workspace may be slower than when using persistent or ephemeral storage. For large projects, synchronization progress is shown in the Che Theia UI status bar. (link:https://github.com/eclipse/che-theia/tree/master/extensions/eclipse-che-theia-file-sync-tracker][Extension in Che Theia repository]).

image::troubleshooting/status-bar-file-sync.png[link="{imagesdir}/troubleshooting/status-bar-file-sync.png",Files synchronization progress]

NOTE: This mode has some limitations: it requires the {prod-short} server to be configured with the ‘common’ PVC strategy and the 'per-user' namespace strategy, and at most one workspace per user can run concurrently.

To configure asynchronous storage for your workspace add the following to workspace configuration:
[source,yaml]
----
attributes:
 asyncPersist: 'true'
 persistVolumes: 'false'
----

The following properties can be set in `che.properties` to configure the behavior of a client such as the User Dashboard:

`che.workspace.storage.available_types`: this configuration property defines a comma-separated list of available values for storage types that clients like Dashboard should propose for users during workspace creation/update. Available values: 'persistent’,'ephemeral', 'async' (e.g. `che.workspace.storage.available_types=persistent,ephemeral,async`).

`che.workspace.storage.preferred_type`: this configuration property defines the default storage type that clients like the User Dashboard should propose for users during workspace creation/update. The 'async' value not recommended as a default type since it's still experimental (e.g. `che.workspace.storage.preferred_type=persistent`)

The Storage Type switcher is available on the *Create Custom Workspace* page of the User Dashboard:

image::workspaces/create-custom-ws-storage-type-2.png[link="{imagesdir}/workspaces/create-custom-ws-storage-type-2.png"]

image::workspaces/create-custom-ws-storage-type.png[link="{imagesdir}/workspaces/create-custom-ws-storage-type.png"]
